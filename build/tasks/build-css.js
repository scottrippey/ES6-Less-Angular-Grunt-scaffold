module.exports = function(grunt) {
	grunt.registerTask('build-css', [ 'generate-master-less', 'less:MASTER-LESS' ]);
	
	grunt.config.merge({
		less: {
			'MASTER-LESS': {
				files: [
					{
						src: 'src/less/master.less',
						dest: 'dist/css/master.combined.css' 
					}
				]
			}
		},
		watch: {
			'ALL-LESS': {
				files: [ 'src/**/*.css', 'src/**/*.less' ],
				tasks: [ 'build-css' ]
			},
			'ALL-LESS-livereload': {
				files: [ 'dist/css/**/*.css' ],
				options: { livereload: true }
			}
		}
	});


	grunt.registerTask('generate-master-less', '', function() {
		generateFileList({
			cwd: 'src/less',
			src: [ 
				'**/*.css',
				'**/*.less',
				'!master.less',
				'../angular-modules/**/*.less'
			],
			dest: 'master.less',
			header: '// THIS FILE IS AUTOMATICALLY GENERATED BY grunt generate-master-less\n',
			footer: '// THIS FILE IS AUTOMATICALLY GENERATED BY grunt generate-master-less\n',
			template: '@import <%= filename.indexOf(".css")+1 ? "(inline) " : "" %>"<%= filename %>";\n',
			join: ''
		});
	});
	
	function generateFileList(options) {
		var _ = grunt.util._;
		var files = grunt.file.expand({ cwd: options.cwd }, options.src);
		
		var results = files.map(function (filename) {
			return _.template(options.template, { 'filename': filename });
		});
		var result = options.header + results.join(options.join) + options.footer;
		grunt.file.write(options.cwd + '/' + options.dest, result);
	}

};